---
---
<!DOCTYPE html>
<html>
    <head>
        <script src="papaparse.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <style>
            *
            {
                margin:0;
                padding:0;
                color:#000;
                font-family:Arial;
                font-size:12px;
            }
            form
            {
                width:500px;
                margin:0 auto;
            }
            *[data-import-csv], textarea
            {
                display:block;
                width:100%;

                padding:1rem;
                margin:1rem;
                border:8px dashed #aaa;
                
                background:#fff;
                border-radius:10px;
                cursor:pointer;
                
                text-align:center;
            }
            *[data-import-csv]:hover, *[data-import-csv].Import, textarea:hover
            {
                border-color:#FA0;
                background: #fdd48f;
            }
            table
            {
                width:80%;
                margin:0 auto;
            }
            tr:hover
            {
                background:#ddd;
            }
            td
            {
                padding:0.15em;
            }
            .List td:nth-child(n+4)
            {
                display:none;
            }
            .Ship td
            {
                border-bottom:1px solid #ccc;
            }
            .Make td
            {
                border-bottom:1px dashed #999;
            }
            th
            {
                text-align:left;
                padding-top:10px;
                padding-bottom:5px;
            }
        </style>
    </head>
    <body>
        <div ng-app="App" ng-controller="Controller" ng-cloak>
            <form ng-hide="(Parser.OutputShip.length + Parser.OutputMake.length) > 0" ng-submit="Convert();">
                <label>Upload/drag-and-drop CSV:</label>
                <input type="file" data-import-csv class="form-control">
                <label>Pase from Excel:</label>
                <textarea ng-model="Paste" ng-change="Convert();"></textarea>
            </form>

            <table class="List Ship" cellpadding="0" cellspacing="0">
                <tr ng-repeat="Row in Parser.OutputHead track by $index">
                    <th ng-repeat="Cell in Row track by $index">{[{Cell}]}</th>
                </tr>
                <tr ng-repeat="Row in Parser.OutputShip track by $index">
                    <td ng-repeat="Cell in Row track by $index">{[{Cell}]}</td>
                </tr>
            </table>
            <table class="List Make" style="page-break-before:always;" cellpadding="0" cellspacing="0">
                <tr ng-repeat="Row in Parser.OutputHead track by $index">
                    <th ng-repeat="Cell in Row track by $index">{[{Cell}]}</th>
                </tr>
                <tr ng-repeat="Row in Parser.OutputMake track by $index">
                    <td ng-repeat="Cell in Row track by $index">{[{Cell}]}</td>
                </tr>
            </table>
            <table class="Count" ng-show="Parser.OutputMake.length > 0" cellpadding="0" cellspacing="0">
                <tr>
                    <th>MP3CDs and CDs:</th>
                    <th>MP3CDs:</th>
                    <th>CDs:</th>
                    <th>DVDs:</th>
                    <th>MCDs:</th>
                </tr>
                <tr>
                    <td>{[{Parser.Total.MP3CD + Parser.Total.CD}]}</td>
                    <td>{[{Parser.Total.MP3CD}]}</td>
                    <td>{[{Parser.Total.CD}]}</td>
                    <td>{[{Parser.Total.DVD}]}</td>
                    <td>{[{Parser.Total.MCD}]}</td>
                </tr>
            </table>
        </div>


        <script>
        </script>
        <script>
var App;
App = angular.module("App", []).config(["$interpolateProvider", function(inInterpolate)
{
    inInterpolate.startSymbol('{[{').endSymbol('}]}');
}]);
App.directive("importCsv", ["$parse", "FactoryParser", function(inParser, FactoryParser)
{

    var directive = {};

    directive.link = function(inScope, inElement, inAttributes){

        function handlerEnter(inEvent){
            if(inEvent){
                inEvent.preventDefault();
            }
            inElement.addClass("Import");
            inEvent.dataTransfer.effectAllowed = 'copy';
            return false;
        }
        
        function handlerDrop(inEvent){
            inElement.removeClass("Import");
            if(inEvent){
                inEvent.preventDefault();
            }
            parse(event.dataTransfer.files[0]);
            return false;
        }
        
        function handlerChange(inEvent){
            inEvent.stopImmediatePropagation();
            parse(inEvent.target.files[0]);
        };
        
        function parse(inFile){
            FactoryParser.Parse(inFile);
        }
        
        function handlerLeave(){
            inElement.removeClass("Import");
        }
        
        
        
        inElement.on("dragenter dragstart dragend dragleave dragover drag drop", function (inEvent) {inEvent.preventDefault();});
        inElement.on('dragenter', handlerEnter);
        inElement.on('dragleave', handlerLeave);
        inElement.on('drop', handlerDrop);
        inElement.on('change', handlerChange);
        inElement.on('click', function(inEvent){
            inEvent.stopImmediatePropagation();
            
        })
    };
    
    return directive;
    
}]);
App.factory("FactorySplitter", [function()
{
    return function(inID)
    {
        var i;
        var output = ["", inID, false];
        if(inID)
        {
            
            if(inID.length > 1)
            {
                // move gs prefix to the end if its there
                if(inID.substring(0, 2).toUpperCase() == "GS")
                {
                    inID = inID.substring(2);
                    output[2] = true;
                }

                //check for binders (Y prefix) and envelopes (PI prefix)
                if(inID[0].toUpperCase() == "Y")
                {
                    return ["Y", inID.substring(1), false];
                }
                if(inID.substring(0, 2).toUpperCase() == "PI")
                {
                    return ["PI", inID.substring(2), false];
                }
            }

            for(i=0; i<inID.length; i++)
            {
                if(isNaN(parseInt( inID[i] )))
                {
                    output[0] = inID.substring(i);
                    output[1] = inID.substring(0, i);
                    break;
                }
            }
        }

        //check for books and study books
        if(output[0] == "" || output[0].toUpperCase() == "S")
        {
            output[0] = "BOOK";
        }
        return output;
    };
}]);
App.factory("FactoryParser", ["FactorySplitter", function(FactorySplitter)
{
    var obj = {};
    
    obj.Code = "PRODUCTCODE";
    obj.CodeSplit = ["Product", "Code", "GS"];
    
    obj.Flip = "MP3CD";
    obj.FlipColumns = [1, 2];
    obj.ShipIDs = [15905, 14609, 14109, 14212];
    obj.ShipCheck = function(inID)
    {
        var i;
        for(i=0; i<obj.ShipIDs.length; i++)
        {
            if(obj.ShipIDs[i] == inID)
            {
                return true;
            }
        }
        return false;
    };
    

    obj.Handler = function(){};
    obj.Parse = function(inData)
    {
        
        Papa.parse(inData, {
            complete: function(results)
            {
                obj.Sort(results);
                obj.Handler(obj.Output);
            }
        });

    };

    obj.Sort = function(results) {
        
        obj.OutputHead = [];
        obj.OutputData = [];
        obj.OutputMake = [];
        obj.OutputShip = [];
        obj.OutputMisc = [];
        obj.Total = {
            CD: 0,
            DVD: 0,
            MP3CD: 0,
            MCD: 0
        };

        var i, j;
        var startPoint = 0;
        var columnIndex = 1;
        var row;
        var split;
        var headerSize = 3;
        
        // find the header
        outer:
        for(i=0; i<results.data.length; i++)
        {
            row = results.data[i];
            for(j=0; j<row.length; j++)
            {
                if(row[j].toUpperCase() === obj.Code)
                {
                    obj.OutputHead.push(row);
                    columnIndex = j;
                    startPoint = i+1;
                    headerSize = row.length;
                    //obj.Output[obj.Output.length-1] = row.concat(obj.CodeSplit);
                    break outer;
                }
            }
        }

        
        for(i=startPoint; i<results.data.length; i++)
        {
            row = results.data[i];
            if(row.length == 1 && row[0] == "")
            {
                continue;
            }
            
            // split ProductCode into Product and Code, and add them as new columns
            split = FactorySplitter(row[columnIndex]);
            var newRow = row.concat(split);

            // expand mp3cd volumes
            // flip mp3cd code and decriptions
            
            if(newRow[headerSize] == obj.Flip)
            {
                var words = newRow[2].replace(/[-(),]/g, '').split(" ");
                var wordNumber;
                var seriesName;
                var setSize;
                var numCheck = false;
                var j, k;

              
                if(words.length > 3)
                {
                    for(j=0; j<words.length; j++)
                    {
                        if(words[j].toUpperCase() == "VOLUME")
                        {
                            if(words[j+1] && words[j+1].toUpperCase() == "SET")
                            {
                                numCheck = true;
                                wordNumber = words[j-1].toUpperCase();
                                words.splice(j-1, 3);
                                seriesName = words.join(" ");
                                break;
                            }
                        }
                    }

                    if(numCheck)
                    {
                        setSize = parseInt(wordNumber);
                        if(isNaN(setSize))
                        {
                            switch(wordNumber)
                            {
                                case "TWO" :
                                    setSize = 2;
                                    break;
                                case "THREE" :
                                    setSize = 3;
                                    break;
                                case "FOUR" :
                                    setSize = 4;
                                    break;
                                case "FIVE" :
                                    setSize = 5;
                                    break;
                                case "SIX" :
                                    setSize = 6;
                                    break;
                                case "SEVEN" :
                                    setSize = 7;
                                    break;
                                case "EIGHT" :
                                    setSize = 8;
                                    break;
                                case "NINE" :
                                    setSize = 9;
                                    break;
                                case "TEN" :
                                    setSize = 10;
                                    break;
                            }
                        }

                        var countDown = parseInt(newRow[headerSize+1]);
                        var copy;
                        for(j=0; j<setSize; j++)
                        {
                            copy = [];
                            for(k=0; k<newRow.length; k++)
                            {
                                copy[k] = newRow[k];
                            }
                            copy[headerSize+1] = countDown-j-1; // code
                            copy[1] = copy[headerSize+1] + copy[headerSize]; // productcode
                            copy[2] = seriesName + " - Volume " + (setSize-j);

                            var temp = copy[obj.FlipColumns[0]];
                            copy[obj.FlipColumns[0]] = copy[obj.FlipColumns[1]];
                            copy[obj.FlipColumns[1]] = temp;
                            obj.OutputData.push(copy);
                        }

                        continue;
                    }
                }

                var temp = newRow[obj.FlipColumns[0]];
                newRow[obj.FlipColumns[0]] = newRow[obj.FlipColumns[1]];
                newRow[obj.FlipColumns[1]] = temp;
            }
            obj.OutputData.push(newRow);
        }

        // split into three lists...
        // extract 4-digit CDs, all DVDs, and all MP3CDs
        // then remove product and code columns
        for(i=0; i<obj.OutputData.length; i++)
        {
            var j;
            var match = false;
            var row = obj.OutputData[i];
            var cut;
            var list = obj.OutputShip;
            var type = row[headerSize].toUpperCase();
            var id = row[headerSize+1];
            switch(type)
            {
                case "CD" :
                    if(id.length == 4)
                    {
                        obj.Total[type] += parseInt(row[0]);
                        list = obj.OutputMake;
                    }
                    break;
                case "DVD" :
                    if(id.length == 4)
                    {
                        obj.Total[type] += parseInt(row[0]);
                        list = obj.OutputMake;
                    }
                    break;
                case "MP3CD" :
                    if(!obj.ShipCheck(id))
                    {
                        obj.Total[type] += parseInt(row[0]);
                        list = obj.OutputMake;
                    }
                    break;
                case "MCD" :
                    obj.Total[type] += parseInt(row[0]);
                    list = obj.OutputMake;
                    break;

                case "PI" :
                    list = obj.OutputMisc;
                    break;
                case "SHIPADJ" :
                    list = obj.OutputMisc;
                    break;
                case "Y" :
                    list = obj.OutputMisc;
                    break;
            }

            list.push(row);
        }

        // pivot make on product then GS then: code or description if its mp3cd (which will have moved into the second columnn :O )
        obj.OutputMake.sort(function(a, b)
        {
            var x, y;
            
            x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }

            x = a[headerSize+2], y = b[headerSize+2];
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
            
            if(a[3].toUpperCase() == "MP3CD")
            {
                x = a[1], y = b[1];
                if(x<y)
                {
                    return -1;
                }
                if(x>y)
                {
                    return 1;
                }
            }
            else
            {
                return a[headerSize+1] - b[headerSize+1];
            }
        });

        // pivot ship (volunteer) on type then description
        obj.OutputShip.sort(function(a, b)
        {
            var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }

            var x = a[2].toLowerCase(), y = b[2].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
        });

        
        for(i=0; i<obj.OutputShip.length-1; i++)
        {
            if(obj.OutputShip[i][3] != obj.OutputShip[i+1][3])
            {
                obj.OutputShip.splice(i+1, 0, ["---", "---", "---"]);
                i++;
            }
        }

        // pivot misc
        obj.OutputMisc.sort(function(a, b)
        {
            var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
            return a[headerSize+1] - b[headerSize+1];
        });

        // stich OutputMisc back onto output Ship
        obj.OutputShip = obj.OutputShip.concat(obj.OutputMisc);

    };

    return obj;
}]);
App.controller("Controller", ["$scope", "FactoryParser", function($scope, FactoryParser)
{
    $scope.Parser = FactoryParser;
    $scope.Paste = "";
    $scope.Parser.Handler = function(inData)
    {
        $scope.$apply();
    };
    $scope.Convert = function()
    {
        $scope.Parser.Sort(Papa.parse($scope.Paste));
    };
}]);    
        </script>
    </body>
</html>
