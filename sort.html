---
---
<!DOCTYPE html>
<html>
    <head>
        <script src="papaparse.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <style>
            *
            {
                margin:0;
                padding:0;
                color:#000;
                font-family:Arial;
                font-size:12px;
            }
            form
            {
                width:500px;
                margin:0 auto;
            }
            *[data-import-csv], textarea
            {
                display:block;
                width:100%;

                padding:1rem;
                margin:1rem;
                border:8px dashed #aaa;
                
                background:#fff;
                border-radius:10px;
                cursor:pointer;
                
                text-align:center;
            }
            *[data-import-csv]:hover, *[data-import-csv].Import, textarea:hover
            {
                border-color:#FA0;
                background: #fdd48f;
            }
            table
            {
                width:80%;
                margin:0 auto;
            }
            tr:hover
            {
                background:#ddd;
            }
            }
        </style>
    </head>
    <body>
        <div ng-app="App" ng-controller="Controller">
            <form ng-hide="Results.length > 0" ng-submit="Convert();">
                <label>Upload/drag-and-drop CSV:</label>
                <input type="file" data-import-csv class="form-control">
                <label>Pase from Excel:</label>
                <textarea ng-model="Paste" ng-change="Convert();"></textarea>
            </form>
            <table>
                <tr ng-repeat="Row in Results track by $index">
                    <td ng-repeat="Cell in Row track by $index">{[{Cell}]}</td>
                </tr>
            </table>
        </div>

        <script>
var App;
App = angular.module("App", []).config(["$interpolateProvider", function(inInterpolate)
{
    inInterpolate.startSymbol('{[{').endSymbol('}]}');
}]);
App.directive("importCsv", ["$parse", "FactoryParser", function(inParser, FactoryParser)
{

    var directive = {};

    directive.link = function(inScope, inElement, inAttributes){

        function handlerEnter(inEvent){
            if(inEvent){
                inEvent.preventDefault();
            }
            inElement.addClass("Import");
            inEvent.dataTransfer.effectAllowed = 'copy';
            return false;
        }
        
        function handlerDrop(inEvent){
            inElement.removeClass("Import");
            if(inEvent){
                inEvent.preventDefault();
            }
            parse(event.dataTransfer.files[0]);
            return false;
        }
        
        function handlerChange(inEvent){
            inEvent.stopImmediatePropagation();
            parse(inEvent.target.files[0]);
        };
        
        function parse(inFile){
            FactoryParser.Parse(inFile);
        }
        
        function handlerLeave(){
            inElement.removeClass("Import");
        }
        
        
        
        inElement.on("dragenter dragstart dragend dragleave dragover drag drop", function (inEvent) {inEvent.preventDefault();});
        inElement.on('dragenter', handlerEnter);
        inElement.on('dragleave', handlerLeave);
        inElement.on('drop', handlerDrop);
        inElement.on('change', handlerChange);
        inElement.on('click', function(inEvent){
            inEvent.stopImmediatePropagation();
            
        })
    };
    
    return directive;
    
}]);
App.factory("FactorySplitter", [function()
{
    return function(inID)
    {
        var i;
        var output = ["", inID];
        if(inID)
        {
            for(i=0; i<inID.length; i++)
            {
                if(isNaN(parseInt( inID[i] )))
                {
                    output[0] = inID.substring(i);
                    output[1] = inID.substring(0, i);
                    break;
                }
            }
        }
        return output;
    };
}]);
App.factory("FactoryParser", ["FactorySplitter", function(FactorySplitter)
{
    var obj = {};
    
    obj.Code = "ProductCode";
    obj.CodeSplit = ["Product", "Code"];
    
    obj.Flip = "MP3CD";
    obj.FlipColumns = [1, 2]
    
    obj.Output = [];
    obj.OutputSort = [];
    obj.OutputMake = [];
    obj.OutputShip = [];

    obj.Handler = function(){};
    obj.Parse = function(inData)
    {
        
        Papa.parse(inData, {
            complete: function(results)
            {
                obj.Sort(results);
                obj.Handler(obj.Output);
            }
        });

    };

    obj.Sort = function(results) {
        
        obj.Output = [];
        obj.OutputSort = [];
        obj.OutputMake = [];
        obj.OutputShip = [];

        var i, j;
        var startPoint = 0;
        var columnIndex = 1;
        var row;
        var split;
        var headerSize = 3;
        
        // find the header
        outer:
        for(i=0; i<results.data.length; i++)
        {
            row = results.data[i];
            for(j=0; j<row.length; j++)
            {
                if(row[j] === obj.Code)
                {
                    obj.Output.push(row);
                    columnIndex = j;
                    startPoint = i+1;
                    headerSize = row.length;
                    obj.Output[obj.Output.length-1] = row.concat(obj.CodeSplit);
                    break outer;
                }
            }
        }

        // split ProductCode and add the parts in new columns
        for(i=startPoint; i<results.data.length; i++)
        {
            row = results.data[i];
            if(row.length == 1 && row[0] == "")
            {
                continue;
            }
            
            split = FactorySplitter(row[columnIndex]);

            
            var newRow = row.concat(split);
            // add book and study types
            if(newRow[headerSize] == "")
            {
                newRow[headerSize] = "BOOK";
            }
            if(newRow[headerSize] == "S")
            {
                newRow[headerSize] = "BOOKSTUDY";
            }
            // flip mp3cd code and decriptions
            if(newRow[headerSize] == obj.Flip)
            {
                var a = obj.FlipColumns[0];
                var b = obj.FlipColumns[1]
                var temp = newRow[a];
                newRow[a] = newRow[b];
                newRow[b] = temp;
            }

            obj.OutputSort.push(newRow);
            
        }
        
        // pivot on product and then code
        obj.OutputSort.sort(function(a, b)
        {
            var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
            return a[headerSize+1] - b[headerSize+1];
        });
        

        // extract 4-digit CDs, all DVDs, and all MP3CDs
        for(i=0; i<obj.OutputSort.length; i++)
        {
            var row = obj.OutputSort[i];
            var cut;
            var extractable = false;
            var type = row[headerSize];
            var id = row[headerSize+1]
            switch(type)
            {
                case "CD" :
                    if(id.length == 4)
                    {
                        extractable = true;
                    }
                    break;
                case "DVD" :
                    extractable = true;
                    break;
                case "MP3CD" :
                    extractable = true;
                    break;
            }

            if(extractable)
            {
                obj.OutputMake.push(row);
                console.log("EXTRACTED:", type, id);
            }
            else
            {
                obj.OutputShip.push(row);
                console.log("INTACT:", type, id);
            }
        }

        // stitch head, output ship, and output make back together
        obj.Output = obj.Output.concat(obj.OutputShip);
        obj.Output.push(["-----"]);
        obj.Output = obj.Output.concat(obj.OutputMake);
    };

    return obj;
}]);
App.controller("Controller", ["$scope", "FactoryParser", function($scope, FactoryParser)
{
    $scope.Parser = FactoryParser;
    $scope.Results = [];
    $scope.Paste = "";
    $scope.Parser.Handler = function(inData)
    {
        $scope.Results = inData;
        $scope.$apply();
    };
    $scope.Convert = function()
    {
        $scope.Parser.Sort(Papa.parse($scope.Paste));
        $scope.Results = $scope.Parser.Output;
        console.log($scope.Results);
    };
}]);    
        </script>
        <!--
        <script>
function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}
        </script>
        -->
    </body>
</html>
