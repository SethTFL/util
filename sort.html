---
---
<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <script src="Tabular.js"></script>
        <script src="papaparse.js"></script>
        <style>
            *
            {
                margin:0;
                padding:0;
                color:#000;
                font-family:Arial;
                font-size:12px;
            }
            form
            {
                width:500px;
                margin:0 auto;
            }
            *[data-import-csv], textarea
            {
                display:block;
                width:100%;

                padding:1rem;
                margin:1rem;
                border:8px dashed #aaa;
                
                background:#fff;
                border-radius:10px;
                cursor:pointer;
                
                text-align:center;
            }
            *[data-import-csv]:hover, *[data-import-csv].Import, textarea:hover
            {
                border-color:#FA0;
                background: #fdd48f;
            }
            table
            {
                width:80%;
                margin:0 auto;
            }
            tr:hover
            {
                background:#ddd;
            }
            td
            {
                padding:0.15em;
            }
            .List td:nth-child(n+4)
            {
                display:none;
            }
            .Ship td
            {
                border-bottom:1px solid #ccc;
            }
            .Make td
            {
                border-bottom:1px dashed #999;
            }
            th
            {
                text-align:left;
                padding-top:10px;
                padding-bottom:5px;
            }
        </style>
    </head>
    <body>
        <div ng-app="App" ng-controller="Controller" ng-cloak>
            <form ng-hide="Done">
                <label>Upload/drag-and-drop CSV:</label>
                <input type="file" data-import-csv class="form-control">
                <label>Pase from Excel:</label>
                <textarea ng-model="Paste" ng-change="Convert();"></textarea>
                <img src="http://thecatapi.com/api/images/get?format=src&type=jpg">
            </form>
            
            <table ng-show="Done" ng-repeat="(Key, Product) in Ship">
                <tr>
                    <td ng-bind="Count(Product);"></td>
                </tr>
                <tr ng-repeat="Row in Product track by $index">
                    <td ng-repeat="Cell in Row track by $index" ng-bind="Cell"></td>
                </tr>
            </table>
            
            <table ng-show="Done" ng-repeat="(Key, Product) in Make">
                <tr>
                    <td ng-bind="Count(Product);"></td>
                </tr>
                <tr ng-repeat="Row in Product track by $index">
                    <td ng-repeat="Cell in Row track by $index" ng-bind="Cell"></td>
                </tr>
            </table>
            
        </div>


        <script>
        </script>
        <script>
var App;
App = angular.module("App", ["Tabular"]).config(["$interpolateProvider", function(inInterpolate)
{
    inInterpolate.startSymbol('{[{').endSymbol('}]}');
}]);
App.directive("importCsv", ["Rows", function(Rows)
{

    var directive = {};

    directive.link = function(inScope, inElement, inAttributes){

        function handlerEnter(inEvent){
            if(inEvent){
                inEvent.preventDefault();
            }
            inElement.addClass("Import");
            inEvent.dataTransfer.effectAllowed = 'copy';
            return false;
        }
        
        function handlerDrop(inEvent){
            inElement.removeClass("Import");
            if(inEvent){
                inEvent.preventDefault();
            }
            parse(event.dataTransfer.files[0]);
            return false;
        }
        
        function handlerChange(inEvent){
            inEvent.stopImmediatePropagation();
            parse(inEvent.target.files[0]);
        }
        
        
        function handlerLeave()
        {
            inElement.removeClass("Import");
        }
        
        function parse(inFile)
        {
            Papa.parse(inFile, {
                complete: function(inCSV)
                {
                    Rows(inCSV.data);
                    inScope.$apply();
                }
            });
        }

        
        inElement.on("dragenter dragstart dragend dragleave dragover drag drop", function (inEvent) {inEvent.preventDefault();});
        inElement.on('dragenter', handlerEnter);
        inElement.on('dragleave', handlerLeave);
        inElement.on('drop', handlerDrop);
        inElement.on('change', handlerChange);
        inElement.on('click', function(inEvent){
            inEvent.stopImmediatePropagation();
            
        })
    };
    
    return directive;
    
}]);
App.factory("Collections", [function()
{
    return {
        Update: function(){},
        Book:[],
        CD:[],
        MP3CDSpecial:[],
        USB:[],
        Misc:[],
        
        CD4:[],
        DVD4:[],
        MCD:[],
        MP3CD:[]
    };
}]);
App.factory("Exceptions", [function()
{
    return [15905, 14609, 14109, 14212];
}]);
App.factory("Catalogue", ["Collections", "Exceptions", function(Collections, Exceptions)
{
    return function(inRow)
    {
        var i;
        var row;
        var exceptionsLUT;
        
        if(inRow.length < 3)
        {
            return;
        }
        
        row = {
            Count:parseInt(inRow[0]),
            ProductCode:inRow[1].toUpperCase(),
            Description:inRow[2],
            Product:"",
            Code:0,
            GS:false,
        };
        

        // check for prefixes
        
        // remove gs prefix
        var firstTwo = row.ProductCode.substring(0, 2);
        if(firstTwo == "GS")
        {
            row.ProductCode = row.ProductCode.substring(2);
            row.GS = true;
            //continue processing
        }
        else
        {
            if(firstTwo == "PI")
            {
                row.Product = "PI";
                row.Code = parseInt(row.ProductCode.substring(2));
                Collections.Misc.push(row);
                return row;
            }
            if(firstTwo[0] == "Y")
            {
                row.Product = "Y";
                row.Code = parseInt(row.ProductCode.substring(1));
                Collections.Misc.push(row);
                return row;
            }
        }
        
        // operate on the rest of the products by cutting product code on the first non-number character
        for(i=0; i<row.ProductCode.length; i++)
        {
            if(isNaN(parseInt( row.ProductCode[i] )))
            {
                row.Product = row.ProductCode.substring(i);
                row.Code = parseInt(row.ProductCode.substring(0, i));
                break;
            }
        }

        if(row.Product == "" || row.Product == "S" || row.Product == "A")
        {
            row.Product = "BOOK";
            Collections.Book.push(row);
            return row;
        }
        
        if(row.Product == "CD")
        {
            if(row.Code > 9999)
            {
                Collections.CD.push(row);
                return;
            }
            Collections.CD4.push(row);
            return;
        }
        
        if(row.Product == "DVD")
        {
            if(row.Code > 9999)
            {
                Collections.DVD.push(row);
                return;
            }
            Collections.DVD4.push(row);
            return;
        }
        
        if(row.Product == "MCD")
        {
            Collections.MCD.push(row);
            return;
        }
        
        if(row.Product == "MP3CD")
        {
            for(i=0; i<Exceptions.length; i++)
            {
                if(row.Code == Exceptions[i])
                {
                    Colections.MP3CDSpecial.push(row)
                    return;
                }
            }
            Collections.MP3CD.push(row);
            return;
        }
        
        if(row.Product == "USB")
        {
            Collections.USB.push(row);
            return;
        }
    };
}]);
App.factory("Rows", ["Catalogue", "Collections", function(Catalogue, Collections)
{
    return function(inData)
    {
        var rows;
        var i, j;
        var cut;
        
        function cut(inTable)
        {
            var i, j;
            for(i=0; i<inTable.length; i++)
            {
                for(j=0; j<inTable[i].length; j++)
                {
                    if(inTable[i][j].toUpperCase() == "PRODUCTCODE")
                    {
                        inTable.splice(0, i+1);
                        return inTable;
                    }
                }
            }
        }
        
        cut(inData);
        for(i=0; i<inData.length; i++)
        {
            Catalogue(inData[i]);
        }
        Collections.Update();
        
    }
}]);
App.controller("Controller", ["$scope", "Rows", "Collections", "Catalogue", function($scope, Rows, Collections, Catalogue)
{
    Collections.Update = function(){
        $scope.Done = true;
    };
    $scope.Count = function(inTable)
    {
        var i;
        var sum = 0;
        for(i=0; i<inTable.length; i++)
        {
            sum += inTable[i].Count;
        }
        return sum;
    };
    
    $scope.Paste = "";
    $scope.Convert = function()
    {
        Rows(Papa.parse($scope.Paste).data);
    };
    
    $scope.Done = false;
    $scope.Ship = [Collections.Book, Collections.CD, Collections.MP3CDSpecial, Collections.USB, Collections.Misc];
    $scope.Make = [Collections.CD4, Collections.DVD4, Collections.MCD, Collections.MP3CD];
    
}]);    
        </script>
    </body>
</html>
