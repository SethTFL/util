---
---
<!DOCTYPE html>
<html>
    <head>
        <script src="papaparse.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <style>
            *
            {
                margin:0;
                padding:0;
                color:#000;
                font-family:Arial;
                font-size:12px;
            }
            form
            {
                width:500px;
                margin:0 auto;
            }
            *[data-import-csv], textarea
            {
                display:block;
                width:100%;

                padding:1rem;
                margin:1rem;
                border:8px dashed #aaa;
                
                background:#fff;
                border-radius:10px;
                cursor:pointer;
                
                text-align:center;
            }
            *[data-import-csv]:hover, *[data-import-csv].Import, textarea:hover
            {
                border-color:#FA0;
                background: #fdd48f;
            }
            table
            {
                width:80%;
                margin:0 auto;
            }
            tr:hover
            {
                background:#ddd;
            }
            td
            {
                padding:0.15em;
            }
            .Ship td
            {
                border-bottom:1px solid #ccc;
            }
            .Make td
            {
                border-bottom:1px dashed #999;
            }
            th
            {
                text-align:left;
                padding-top:10px;
                padding-bottom:5px;
            }
        </style>
    </head>
    <body>
        <div ng-app="App" ng-controller="Controller">
            <form ng-hide="(Parser.OutputShip.length + Parser.OutputMake.length) > 0" ng-submit="Convert();">
                <label>Upload/drag-and-drop CSV:</label>
                <input type="file" data-import-csv class="form-control">
                <label>Pase from Excel:</label>
                <textarea ng-model="Paste" ng-change="Convert();"></textarea>
            </form>

            <table class="Ship" cellpadding="0" cellspacing="0">
                <tr ng-repeat="Row in Parser.OutputHead track by $index">
                    <th ng-repeat="Cell in Row track by $index">{[{Cell}]}</th>
                </tr>
                <tr ng-repeat="Row in Parser.OutputShip track by $index">
                    <td ng-repeat="Cell in Row track by $index">{[{Cell}]}</td>
                </tr>
            </table>
            <table class="Make" style="page-break-before:always;" cellpadding="0" cellspacing="0">
                <tr ng-repeat="Row in Parser.OutputHead track by $index">
                    <th ng-repeat="Cell in Row track by $index">{[{Cell}]}</th>
                </tr>
                <tr ng-repeat="Row in Parser.OutputMake track by $index">
                    <td ng-repeat="Cell in Row track by $index">{[{Cell}]}</td>
                </tr>
            </table>

        </div>

        <script>
var App;
App = angular.module("App", []).config(["$interpolateProvider", function(inInterpolate)
{
    inInterpolate.startSymbol('{[{').endSymbol('}]}');
}]);
App.directive("importCsv", ["$parse", "FactoryParser", function(inParser, FactoryParser)
{

    var directive = {};

    directive.link = function(inScope, inElement, inAttributes){

        function handlerEnter(inEvent){
            if(inEvent){
                inEvent.preventDefault();
            }
            inElement.addClass("Import");
            inEvent.dataTransfer.effectAllowed = 'copy';
            return false;
        }
        
        function handlerDrop(inEvent){
            inElement.removeClass("Import");
            if(inEvent){
                inEvent.preventDefault();
            }
            parse(event.dataTransfer.files[0]);
            return false;
        }
        
        function handlerChange(inEvent){
            inEvent.stopImmediatePropagation();
            parse(inEvent.target.files[0]);
        };
        
        function parse(inFile){
            FactoryParser.Parse(inFile);
        }
        
        function handlerLeave(){
            inElement.removeClass("Import");
        }
        
        
        
        inElement.on("dragenter dragstart dragend dragleave dragover drag drop", function (inEvent) {inEvent.preventDefault();});
        inElement.on('dragenter', handlerEnter);
        inElement.on('dragleave', handlerLeave);
        inElement.on('drop', handlerDrop);
        inElement.on('change', handlerChange);
        inElement.on('click', function(inEvent){
            inEvent.stopImmediatePropagation();
            
        })
    };
    
    return directive;
    
}]);
App.factory("FactorySplitter", [function()
{
    return function(inID)
    {
        var i;
        var output = ["", inID];
        if(inID)
        {
            
            if(inID.length > 1)
            {
                // remove gs prefix if its there
                if(inID.substring(0, 2).toUpperCase() == "GS")
                {
                    inID = inID.substring(2);
                }

                //check for binders (Y) and envelopes (PI)
                if(inID[0].toUpperCase() == "Y")
                {
                    return ["Y", inID.substring(1)];
                }
                if(inID.substring(0, 2).toUpperCase() == "PI")
                {
                    return ["PI", inID.substring(2)];
                }
            }

            for(i=0; i<inID.length; i++)
            {
                if(isNaN(parseInt( inID[i] )))
                {
                    output[0] = inID.substring(i);
                    output[1] = inID.substring(0, i);
                    break;
                }
            }
        }

        //check for books and study books
        if(output[0] == "")
        {
            output[0] = "BOOK";
        }
        if(output[0].toUpperCase() == "S")
        {
            output[0] = "BOOKST";
        }
        return output;
    };
}]);
App.factory("FactoryParser", ["FactorySplitter", function(FactorySplitter)
{
    var obj = {};
    
    obj.Code = "PRODUCTCODE";
    obj.CodeSplit = ["Product", "Code"];
    
    obj.Flip = "MP3CD";
    obj.FlipColumns = [1, 2];

    obj.Handler = function(){};
    obj.Parse = function(inData)
    {
        
        Papa.parse(inData, {
            complete: function(results)
            {
                obj.Sort(results);
                obj.Handler(obj.Output);
            }
        });

    };

    obj.Sort = function(results) {
        
        obj.OutputHead = [];
        obj.OutputData = [];
        obj.OutputMake = [];
        obj.OutputShip = [];
        obj.OutputMisc = [];

        var i, j;
        var startPoint = 0;
        var columnIndex = 1;
        var row;
        var split;
        var headerSize = 3;
        
        // find the header
        outer:
        for(i=0; i<results.data.length; i++)
        {
            row = results.data[i];
            for(j=0; j<row.length; j++)
            {
                if(row[j].toUpperCase() === obj.Code)
                {
                    obj.OutputHead.push(row);
                    columnIndex = j;
                    startPoint = i+1;
                    headerSize = row.length;
                    //obj.Output[obj.Output.length-1] = row.concat(obj.CodeSplit);
                    break outer;
                }
            }
        }

        // split ProductCode and add the parts in new columns
        for(i=startPoint; i<results.data.length; i++)
        {
            row = results.data[i];
            if(row.length == 1 && row[0] == "")
            {
                continue;
            }
            
            split = FactorySplitter(row[columnIndex]);
            var newRow = row.concat(split);

            // expand volumes
            // flip mp3cd code and decriptions
            if(newRow[headerSize] == obj.Flip)
            {
                var a = obj.FlipColumns[0];
                var b = obj.FlipColumns[1]
                var temp = newRow[a];
                newRow[a] = newRow[b];
                newRow[b] = temp;
            }
            obj.OutputData.push(newRow);
        }

        // split into three lists...
        // extract 4-digit CDs, all DVDs, and all MP3CDs
        // then remove product and code columns
        for(i=0; i<obj.OutputData.length; i++)
        {
            var row = obj.OutputData[i];
            var cut;
            var list = obj.OutputShip;
            var type = row[headerSize].toUpperCase();
            var id = row[headerSize+1]
            switch(type)
            {
                case "CD" :
                    if(id.length == 4)
                    {
                        list = obj.OutputMake;
                    }
                    break;
                case "DVD" :
                    if(id.length == 4)
                    {
                        list = obj.OutputMake;
                    }
                    break;
                case "MP3CD" :
                    list = obj.OutputMake;
                    break;
                case "MCD" :
                    list = obj.OutputMake;
                    break;

                case "PI" :
                    list = obj.OutputMisc;
                    break;
                case "SHIPADJ" :
                    list = obj.OutputMisc;
                    break;
                case "Y" :
                    list = obj.OutputMisc;
                    break;
            }

            //row.splice(row.length-2);
            list.push(row);
        }

        // pivot  make on product and then code
        obj.OutputMake.sort(function(a, b)
        {
            var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
            return a[headerSize+1] - b[headerSize+1];
        });

        // pivot ship (volunteer) on type then description
        obj.OutputShip.sort(function(a, b)
        {
            var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }

            var x = a[2].toLowerCase(), y = b[2].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
        });

        // pivot misc
        obj.OutputMisc.sort(function(a, b)
        {
            var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
            if(x<y)
            {
                return -1;
            }
            if(x>y)
            {
                return 1;
            }
            return a[headerSize+1] - b[headerSize+1];
        });

        // stich OutputMisc back onto output Ship
        obj.OutputShip = obj.OutputShip.concat(obj.OutputMisc);

    };

    return obj;
}]);
App.controller("Controller", ["$scope", "FactoryParser", function($scope, FactoryParser)
{
    $scope.Parser = FactoryParser;
    $scope.Paste = "";
    $scope.Parser.Handler = function(inData)
    {
        $scope.$apply();
    };
    $scope.Convert = function()
    {
        $scope.Parser.Sort(Papa.parse($scope.Paste));
    };
}]);    
        </script>
        <!--
        <script>
function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}
        </script>
        -->
    </body>
</html>
