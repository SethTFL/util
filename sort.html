---
---
<!DOCTYPE html>
<html>
    <head>
        <script src="papaparse.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <style>
            *
            {
                margin:0;
                padding:0;
                color:#000;
                font-family:Arial;
                font-size:12px;
            }
            input[data-import-csv]
            {
                display:block;
                padding:3rem;
                margin:1rem;
                background:#fff;
                border:8px dashed #aaa;
                border-radius:10px;
                text-align:center;
            }
            input[data-import-csv]:hover, input[data-import-csv].Import
            {
                border-color:#FA0;
            }
        </style>
    </head>
    <body>
        <div ng-app="App" ng-controller="Controller">
            <input type="file" data-import-csv class="form-control" ng-hide="Results.length > 0">
            <table>
                <tr ng-repeat="Row in Results track by $index">
                    <td ng-repeat="Cell in Row track by $index">{[{Cell}]}</td>
                </tr>
            </table>
        </div>

        <script>
var App;
App = angular.module("App", []).config(["$interpolateProvider", function(inInterpolate)
{
    inInterpolate.startSymbol('{[{').endSymbol('}]}');
}]);
App.directive("importCsv", ["$parse", "FactoryParser", function(inParser, FactoryParser)
{

    var directive = {};

    directive.link = function(inScope, inElement, inAttributes){

        function handlerEnter(inEvent){
            if(inEvent){
                inEvent.preventDefault();
            }
            inElement.addClass("Import");
            inEvent.dataTransfer.effectAllowed = 'copy';
            return false;
        }
        
        function handlerDrop(inEvent){
            inElement.removeClass("Import");
            if(inEvent){
                inEvent.preventDefault();
            }
            parse(event.dataTransfer.files[0]);
            return false;
        }
        
        function handlerChange(inEvent){
            inEvent.stopImmediatePropagation();
            parse(inEvent.target.files[0]);
        };
        
        function parse(inFile){
            FactoryParser.Parse(inFile);
        }
        
        function handlerLeave(){
            inElement.removeClass("Import");
        }
        
        
        
        inElement.on("dragenter dragstart dragend dragleave dragover drag drop", function (inEvent) {inEvent.preventDefault();});
        inElement.on('dragenter', handlerEnter);
        inElement.on('dragleave', handlerLeave);
        inElement.on('drop', handlerDrop);
        inElement.on('change', handlerChange);
        inElement.on('click', function(inEvent){
            inEvent.stopImmediatePropagation();
            
        })
    };
    
    return directive;
    
}]);
App.factory("FactorySplitter", [function()
{
    return function(inID)
    {
        var i;
        var output = ["", inID];
        if(inID)
        {
            for(i=0; i<inID.length; i++)
            {
                if(isNaN(parseInt( inID[i] )))
                {
                    output[0] = inID.substring(i);
                    output[1] = inID.substring(0, i);
                    break;
                }
            }
        }
        return output;
    };
}]);
App.factory("FactoryParser", ["FactorySplitter", function(FactorySplitter)
{
    var obj = {};
    
    obj.Code = "ProductCode";
    obj.CodeSplit = ["Product", "Code"];
    
    obj.Flip = "MP3CD";
    obj.FlipColumns = [1, 2]
    
    obj.Output = [];
    obj.OutputSort = [];
    
    obj.Handler = function(){};
    obj.Parse = function(inData)
    {
        obj.Output = [];
        obj.OutputSort = [];
        
        Papa.parse(inData, {
            complete: function(results) {
                
                var i, j;
                var startPoint = 0;
                var columnIndex = 1;
                var row;
                var split;
                var headerSize = 3;
                
                outer:
                for(i=0; i<results.data.length; i++)
                {
                    row = results.data[i];
                    for(j=0; j<row.length; j++)
                    {
                        if(row[j] === obj.Code)
                        {
                            obj.Output.push(row);
                            columnIndex = j;
                            startPoint = i+1;
                            headerSize = row.length;
                            obj.Output[obj.Output.length-1] = row.concat(obj.CodeSplit);
                            break outer;
                        }
                    }
                }

                for(i=startPoint; i<results.data.length-1; i++)
                {
                    row = results.data[i];
                    split = FactorySplitter(row[columnIndex]);
                    obj.OutputSort.push(row.concat(split));
                }
                
                obj.OutputSort.sort(function(a, b)
                {
                    var x = a[headerSize].toLowerCase(), y = b[headerSize].toLowerCase();
                    if(x<y)
                    {
                        return -1;
                    }
                    if(x>y)
                    {
                        return 1;
                    }
                    return a[headerSize+1] - b[headerSize+1];
                });
                

                for(i=0; i<obj.OutputSort.length; i++)
                {
                    row = obj.OutputSort[i];
                    if(row[headerSize] == obj.Flip)
                    {
                        var a = obj.FlipColumns[0];
                        var b = obj.FlipColumns[1]
                        var temp = row[a];
                        row[a] = row[b];
                        row[b] = temp;
                    }
                }

                obj.Output = obj.Output.concat(obj.OutputSort);
                obj.Handler(obj.Output);
            }
        });

    };
    return obj;
}]);
App.controller("Controller", ["$scope", "FactoryParser", function($scope, FactoryParser)
{
    $scope.Parser = FactoryParser;
    $scope.Results = [];
    $scope.File = "";
    $scope.Parser.Handler = function(inData)
    {
        $scope.Results = inData;
        $scope.File = Papa.unparse(inData);
        $scope.$apply();
    };
}]);    
        </script>
        <!--
        <script>
function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}
        </script>
        -->
    </body>
</html>
