---
---
<!DOCTYPE html>
<html>
    <head>
        <style>
            .Editor
            {
                width:50%;
                float:left;
            }
        </style>
    </head>
    <body>
        <dl class="Editor HTML">
            <dt>HTML Editor</dt>
            <dd>
                <button class="Transfer DOM" onclick="ToDOM()">Transfer →</button>
            </dd>
            <dd>
                <textarea class="Stage" style="width:100%; min-height:300px; white-space:nowrap;"></textarea>
            </dd>
        </dl>
        <dl class="Editor DOM">
            <dt>DOM Editor</dt>
            <dd>
                <button onclick="ToHTML()">← Transfer</button>
                <button onclick="FixTitles()">Convert P+Strong to H2</button>
                <button onclick="FixFootnotes()">Re-link Footnotes</button>
                <button onclick="QuoteBlockCreate()">Create Block Quote</button>
                <button onclick="QuoteBlockRemove()">Remove Block Quote</button>
                <button onclick="QuotePullCreate()">Create Pull Quote</button>
                <button onclick="QuotePullRemove()">Remove Pull Quote</button>
                <button onclick="console.log(DOMSelection())">Trace Selection</button>
            </dd>
            <dd>
                <div onmouseup="SelectionCreate()" class="Stage" style="max-height:600px; overflow-y:scroll;"></div>
            </dd>
        </dl>
        <script>
var StageHTML = document.querySelector(".Editor.HTML .Stage");
var StageDOM = document.querySelector(".Editor.DOM .Stage");
var Selection = [];
//// utility functions ///////////////////////
function Iterate(inSelector, inProcessor)
{
    var i;
    var elements;
    elements = document.querySelectorAll(inSelector);
    for(i=0; i<elements.length; i++)
    {
        inProcessor(elements[i]);
    } 
}
function DOMSelection()
{
    var selection;
    var pathStart, pathStop, pathBetween;
    var output;

    selection = window.getSelection();
    output = {
          Text: selection.toString(),
            Up: FindStrand(selection.anchorNode, StageDOM),
          Down: FindStrand(selection.focusNode, StageDOM),
    };
    output.Across = FindBetween(output.Up[0], output.Down[0])

    return output;
}
function FindStrand(inElement, inRoot)
{
    var list = [inElement];
    while(inElement = inElement.parentNode)
    {
        if(inElement == inRoot)
            return list.reverse();
        
        list.push(inElement);
    }
    return false;
}
function FindBefore(inElement1, inElement2)
{
    var list;
    list = [inElement1];
    if(inElement1 == inElement2)
    {
        return list;
    }
    while(inElement1 = inElement1.nextSibling)
    {
        list.push(inElement1);
        if(inElement1 == inElement2)
        {
            return list;
        }
    }
    return false;
}
function FindBetween(inElement1, inElement2)
{
    var before;

    before = FindBefore(inElement1, inElement2);
    if(before)
    {
        return before;
    }

    before = FindBefore(inElement2, inElement1);
    if(before)
    {
        return before;
    }

    return false;
}
//// commands ////////////////////////////////
function ToHTML()
{
    StageHTML.value = StageDOM.innerHTML;
}
function ToDOM()
{
    StageDOM.innerHTML = StageHTML.value;
}
function QuoteBlockCreate()
{
    var replacement;
    var between;
    var text;
    var i;

    replacement = document.createElement("blockquote");
    between = DOMSelection().Across;
    if(!between)
        return false;

    text = "";
    StageDOM.insertBefore(replacement, between[0]);

    for(i=0; i<between.length; i++)
    {
        if(between[i].innerHTML)
        {
            text += between[i].innerHTML + "<br/>";
        }
        StageDOM.removeChild(between[i]);
    }
    replacement.innerHTML = text;
    return replacement;
}
function QuoteBlockRemove()
{
    var selection = DOMSelection();
    var block;
    var text;
    if(!selection.Across)
        return;
    var block = selection.Across[0]
    if(block.nodeName.toUpperCase() == "BLOCKQUOTE")
    {
        text = "<p>" + block.innerHTML.split("<br>").join("</p><p>") + "</p>";
        block.insertAdjacentHTML("beforeBegin", text);
        StageDOM.removeChild(block);
    }
}
function QuotePullCreate()
{
    var selection, quote;
    selection = DOMSelection();
    if(!selection.Across)
    {
        return;
    }
    quote = document.createElement("h6");
    quote.innerHTML = selection.Text;
    StageDOM.insertBefore(quote, selection.Across[0]);
}
function QuotePullRemove()
{
    var selection = DOMSelection();
    if(!selection.Across)
        return;
    if(selection.Across[0].nodeName.toUpperCase() == "H6")
    {
        StageDOM.removeChild(selection.Across[0]);
    }
}
function FixTitles()
{
    function ProcessParagraph(inElement)
    {
        var prefix = "<strong>";
        var suffix = "</strong>";
        var replacement;
        if(inElement.innerHTML.substring(0, prefix.length) == prefix)
        {
            if(inElement.innerHTML.substring(inElement.innerHTML.length - suffix.length) == suffix)
            {
                console.log("title:", inElement.innerHTML);
                replacement = document.createElement("h2");
                replacement.innerHTML = inElement.innerText;
                inElement.parentNode.replaceChild(replacement, inElement);
            }
        }
    }

    Iterate("p", ProcessParagraph);
}
function FixFootnotes()
{
    function ProcessCopy(inElement)
    {
        inElement.setAttribute("href", "#"+ (inElement.testContent || inElement.innerText));
    }
    function ProcessFooter(inElement)
    {
        inElement.setAttribute("name", inElement.testContent || inElement.innerText);
        inElement.removeAttribute("href");
    }

    Iterate("a[href*='#_ftnref']", ProcessFooter);
    Iterate("a[href*='#_ftn']", ProcessCopy)
    Iterate("a[href*='#_msoanchor']", ProcessFooter);
    Iterate("a[href*='#_msocom']", ProcessCopy);
}
function SelectionCreate()
{
    SelectionRemove();
    
    var selection = DOMSelection();
    if(!selection.Across)
        return;
    
    Selection = selection.Across;
    for(i=0; i<Selection.length; i++)
    {
        if(Selection[i].style)
            Selection[i].style.border = "2px dotted #FA0";
    }
}
function SelectionRemove()
{
    for(i=0; i<Selection.length; i++)
    {
        if(Selection[i] && Selection[i].style)
            Selection[i].removeAttribute("style");
    }
}
        </script>
    </body>
</html>