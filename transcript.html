---
---
<!DOCTYPE html>
<html>
    <head>
        <style>
            body
            {
                font-family:monospace;
            }
            .Editor
            {
                max-width: 960px;
                margin:0 auto;
            }
            dd
            {
                margin:0;
                padding:5px;
            }
            .Stage
            {
                max-width:90%;
                min-height:200px;
                border:1px solid #ddd;
                padding:8px;
                background:#eee;
                color:#333;
                font-size:12px;
                font-family:monospace;
            }
            .Stage ::selection
            {
                background:#FC0;
            }
            .Stage .Selection
            {
                border:1px solid #F30;
            }
            fieldset
            {
                display:inline;
                padding:5px;
            }
            .FAR
            {
                width:80px;
                text-decoration:underline;
            }
            .FAR.Find
            {
                text-align:right;
            }
            h6
            {
                font-size: 100%;
                font-style: italic;
            }
        </style>
    </head>
    <body onload="ToHTML()">
        <dl class="Editor HTML">
            <dt>HTML String Editor</dt>
            <dd>
                <button onclick="FixNewlines()">Remove Empty Lines</button>
                &nbsp;
                <input type="text" class="FAR Find"/>
                <button onclick="FixCustom()">Becomes ⇝</button>
                <input type="text" class="FAR Replace"/>
                &nbsp;
                <button class="Transfer DOM" onclick="ToDOM()">Convert to DOM Objects →</button>
            </dd>
            <dd>
                <textarea class="Stage" style="width:100%; white-space:nowrap;"></textarea>
            </dd>
        </dl>
        <dl class="Editor DOM">
            <dt>DOM Object Editor</dt>
            <dd>
                <button onclick="ToHTML()">← Convert to HTML string</button>
                <button onclick="FixTitles()">Convert P+Strong to H2</button>
                <button onclick="FixFootnotes()">Re-link Footnotes</button>
            </dd>
            <dd>
                <button onclick="QuoteBlockCreate()">Block Quote</button>
                <button onclick="QuoteBlockRemove()">Remove Block Quote</button>
                <button onclick="QuotePullCreate()">Pull Quote</button>
                <button onclick="QuotePullRemove()">Remove Pull Quote</button>
                <button onclick="FootnoteRemove()">Remove footnote</button>
            </dd>
            <dd>
                <div onmouseup="SelectionCreate()" class="Stage" style="max-height:600px; overflow-y:scroll;"></div>
            </dd>
        </dl>
        <script>
var PanelHTML = document.querySelector(".Editor.HTML");
var PanelDOM = document.querySelector(".Editor.DOM");
var StageHTML = document.querySelector(".Editor.HTML .Stage");
var StageDOM = document.querySelector(".Editor.DOM .Stage");
var FARFind = document.querySelector(".FAR.Find");
var FARReplace = document.querySelector(".FAR.Replace");
var Selection = [];
//// utility functions ///////////////////////
function Iterate(inSelector, inProcessor)
{
    var i;
    var elements;
    elements = document.querySelectorAll(inSelector);
    for(i=0; i<elements.length; i++)
    {
        inProcessor(elements[i]);
    } 
}
function DOMSelection()
{
    var selection;
    var pathStart, pathStop, pathBetween;
    var output;

    selection = window.getSelection();
    output = {
            Text: selection.toString(),
              Up: FindStrand(selection.anchorNode, StageDOM),
            Down: FindStrand(selection.focusNode, StageDOM),
          Across: false
    };
    if(output.Up && output.Down)
    {
        output.Across = FindBetween(output.Up[0], output.Down[0]);
    }
    return output;
}
function FindStrand(inElement, inRoot)
{
    var list = [inElement];
    while(inElement = inElement.parentNode)
    {
        if(inElement == inRoot)
        {
            return list.reverse();
        }
        if(inElement.nodeType != 3)
        {
            list.push(inElement);
        }
    }
    return false;
}
function FindBefore(inElement1, inElement2)
{
    var list;
    list = [inElement1];
    if(inElement1 == inElement2)
    {
        return list;
    }
    while(inElement1 = inElement1.nextSibling)
    {
        if(inElement1.nodeType != 3)
        {
            list.push(inElement1);
        }
        if(inElement1 == inElement2)
        {
            return list;
        }
    }
    return false;
}
function FindBetween(inElement1, inElement2)
{
    var before;

    before = FindBefore(inElement1, inElement2);
    if(before)
    {
        return before;
    }

    before = FindBefore(inElement2, inElement1);
    if(before)
    {
        return before;
    }

    return false;
}
//// commands ////////////////////////////////
function ToHTML()
{
    SelectionRemove();
    var text = "";
    var str;
    var i;
    for(i=0; i<StageDOM.childNodes.length; i++)
    {
        text += (StageDOM.childNodes[i].outerHTML || StageDOM.childNodes[i].nodeValue);
    }
    StageHTML.value = text;
    PanelHTML.style.display = "block";
    PanelDOM.style.display = "none";
}
function ToDOM()
{
    SelectionRemove();
    StageDOM.innerHTML = StageHTML.value;
    PanelHTML.style.display = "none";
    PanelDOM.style.display = "block";
}
function QuoteBlockCreate()
{
    var replacement;
    var between;
    var text;
    var i;

    replacement = document.createElement("blockquote");
    if(Selection.length == 0 || Selection[0].nodeName == "BLOCKQUOTE")
        return false;

    text = "";
    StageDOM.insertBefore(replacement, Selection[0]);

    for(i=0; i<Selection.length; i++)
    {
        if(Selection[i].innerHTML)
        {
            text += Selection[i].innerHTML + "<br/>";
        }
        StageDOM.removeChild(Selection[i]);
    }
    replacement.innerHTML = text;
    return replacement;
}
function QuoteBlockRemove()
{
    var block;
    var text;
    if(Selection.length == 0)
        return;
    var block = Selection[0];
    if(block.nodeName.toUpperCase() == "BLOCKQUOTE")
    {
        text = "<p>" + block.innerHTML.split("<br>").join("</p><p>") + "</p>";
        block.insertAdjacentHTML("beforeBegin", text);
        StageDOM.removeChild(block);
    }
}
function QuotePullCreate()
{
    var selection, quote, string;
    selection = DOMSelection();
    if(!selection.Across)
    {
        return;
    }
    quote = document.createElement("h6");
    string = selection.Text;
    string = string.charAt(0).toUpperCase() + string.slice(1);
    if(string[string.length-1] != ".")
    {
        string = string.concat(".");
    }
    quote.innerHTML = string;
    StageDOM.insertBefore(quote, selection.Across[0]);
}
function QuotePullRemove()
{
    var selection = DOMSelection();
    if(!selection.Across)
        return;
    if(selection.Across[0].nodeName.toUpperCase() == "H6")
    {
        StageDOM.removeChild(selection.Across[0]);
    }
}
function FootnoteRemove()
{
    var selection = DOMSelection();
    if(!selection.Across)
        return;

    var p = selection.Across[0];
    var a = p.querySelector("a");
    var name = a.getAttribute("name");
    var otherA = document.querySelector("a[href='#"+name+"']");
    var text = a.parentNode.innerHTML

    quote = document.createElement("h6");
    quote.innerHTML = text.substring(text.indexOf("“")+1, text.indexOf("”"));
    StageDOM.insertBefore(quote, otherA.parentNode);

    otherA.parentNode.removeChild(otherA);
    p.parentNode.removeChild(p);
}
function FixTitles()
{
    function ProcessParagraph(inElement)
    {
        var prefix = "<strong>";
        var suffix = "</strong>";
        var replacement;
        if(inElement.innerHTML.substring(0, prefix.length) == prefix)
        {
            if(inElement.innerHTML.substring(inElement.innerHTML.length - suffix.length) == suffix)
            {
                replacement = document.createElement("h2");
                replacement.innerHTML = inElement.innerText;
                inElement.parentNode.replaceChild(replacement, inElement);
            }
        }
    }

    Iterate("p", ProcessParagraph);
}
function FixFootnotes()
{
    function ProcessCopy(inElement)
    {
        inElement.setAttribute("href", "#"+ (inElement.testContent || inElement.innerText));
    }
    function ProcessFooter(inElement)
    {
        inElement.setAttribute("name", inElement.testContent || inElement.innerText);
        inElement.removeAttribute("href");
    }

    Iterate("a[href*='#_ftnref']", ProcessFooter);
    Iterate("a[href*='#_ftn']", ProcessCopy)
    Iterate("a[href*='#_msoanchor']", ProcessFooter);
    Iterate("a[href*='#_msocom']", ProcessCopy);
}
function FixNewlines()
{
    StageHTML.value = StageHTML.value.replace(/^\s*$(?:\r\n?|\n)/gm, "");
}
function FixCustom()
{
    StageHTML.value = StageHTML.value.split(FARFind.value).join(FARReplace.value);
}
function SelectionCreate()
{
    SelectionRemove();

    var selection = DOMSelection();
    if(selection.Across)
    {
        Selection = selection.Across;
        for(i=0; i<Selection.length; i++)
        {
            Selection[i].className="Selection"
        }
        return true;
    }
    return false;
}
function SelectionRemove()
{
    for(i=0; i<Selection.length; i++)
    {
        Selection[i].removeAttribute("class");
    }
}
        </script>
    </body>
</html>