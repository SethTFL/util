---
---
<!DOCTYPE html>
<html>
    <head>
        <style>
            body
            {
                font-family:sans-serif;
                font-size:11px;
            }
            .Editor
            {
                margin:0 auto;
            }
            dt
            {
                font-weight:bold;
            }
            dd
            {
                margin:0;
                padding:5px;
                border-top:1px dotted #ddd;
            }
            textarea
            {
                font-family:monospace;
            }
            button
            {
                padding:3px 10px 3px 10px;
                border:none;
                border-radius:3px;
                cursor:pointer;
                background:#0cc22a;
                color:#fff;
            }
            button:hover
            {
                background:#555;
            }
            .Stage
            {
                min-height:200px;
                border:1px solid #ddd;
                padding:8px;
                background:#eee;
                color:#333;
                font-size:12px;
            }
            .Stage ::selection
            {
                background:#FC0;
            }
            .Stage .Selection
            {
                border:1px solid #F30;
            }
            .Stage > *
            {
                border-top: 1px dotted #bcbcbc;
            }
            .Stage h6
            {
                max-width:500px;
                font-size: 200%;
                font-style: italic;
            }
            .Stage blockquote
            {
                font-style:italic;
                font-size:110%;
            }
            .Stage hr
            {
                padding:3px;
                background:#a00;
            }
            fieldset
            {
                display:inline;
                padding:5px;
            }
            .FAR
            {
                width:80px;
                text-decoration:underline;
            }
            .FAR.Find
            {
                text-align:right;
            }
        </style>
    </head>
    <body onload="ToHTML()">
        <dl class="Editor HTML">
            <dd>
                <span> Editor:</span>
                <span>
                    <button class="Transfer DOM" onclick="ToDOM()">DOM Objects Editor</button>
                </span>
            </dd>
            <dd>
                <span> Document:</span>
                <span>
                    <button onclick="FixNewlines()">Remove Empty Lines</button>
                    &nbsp;
                    <input type="text" class="FAR Find"/>
                    <button onclick="FixCustom()">Becomes ⇝</button>
                    <input type="text" class="FAR Replace"/>
                    &nbsp;
                </span>
            </dd>
            <dd>
                <textarea class="Stage" style="width:100%; white-space:nowrap;">
                </textarea>
            </dd>
        </dl>
        <dl class="Editor DOM">
            <dd>
                <span> Editor:</span>
                <span>
                    <button onclick="ToHTML()">HTML String Editor</button>
                </span>
            </dd>
            <dd>
                <span> Document:</span>
                <span>
                    <button onclick="FixTitles()">Convert P+Strong to H2</button>
                    <button onclick="FixFootnotes()">Re-link Footnotes</button>
                </span>
            </dd>
            <dd>
                <span> Blockquote:</span>
                <span>
                    <button onclick="QuoteBlockCreate()" title="Convert Paragraphs to Blockquote">&rsh;</button>
                    <button onclick="QuoteBlockRemove()" title="Convert Blockquote to Paragraphs">&ldsh;</button>
                </span>
                <span> Pullquote:</span>
                <span>
                    <button onclick="QuotePullCreate()" title="Copy Text as Pullquote">&boxbox;</button>
                    <button onclick="QuotePullRemove()" title="Delete Pullquote">&times;</button>
                    <button onclick="QuotePullMove(false)" title="Move Pullquote Up">&UpTeeArrow;</button>
                    <button onclick="QuotePullMove(true)" title="Move Pullquote Down">&DownTeeArrow;</button>
                    <button onclick="QuotePullSpread()" title="Redistribute Pullquotes">&UpArrowDownArrow;</button>
                </span>
                <span> Footnote:</span>
                <span>
                    <button onclick="FootnoteRemove(false)" title="Delete Footnotes">&times;</button>
                    <button onclick="FootnoteRemove(true) " title="Convert Footnotes into Pullquotes (Requires re-linked footnotes, uses quotation marks to )">&curarr;</button>
                </span>
            </dd>
            <dd>
                <div onmouseup="SelectionCreate()" class="Stage" style="max-height:600px; overflow-y:scroll;"></div>
            </dd>
        </dl>
        <script>
var PanelHTML = document.querySelector(".Editor.HTML");
var PanelDOM = document.querySelector(".Editor.DOM");
var StageHTML = document.querySelector(".Editor.HTML .Stage");
var StageDOM = document.querySelector(".Editor.DOM .Stage");
var FARFind = document.querySelector(".FAR.Find");
var FARReplace = document.querySelector(".FAR.Replace");
var Selection = {};
//// utility functions ///////////////////////
function Iterate(inSelector, inProcessor)
{
    var i;
    var elements;
    elements = document.querySelectorAll(inSelector);
    for(i=0; i<elements.length; i++)
    {
        inProcessor(elements[i]);
    } 
}
function DOMSelection()
{
    var selection;
    var pathStart, pathStop, pathBetween;
    var output;

    selection = window.getSelection();
    output = {
            Text: selection.toString(),
              Up: FindStrand(selection.anchorNode, StageDOM),
            Down: FindStrand(selection.focusNode, StageDOM),
          Across: false
    };
    if(output.Up && output.Down)
    {
        output.Across = FindBetween(output.Up[0], output.Down[0]);
    }
    Selection = output;
    return output;
}
function FindStrand(inElement, inRoot)
{
    var list = [inElement];
    while(inElement = inElement.parentNode)
    {
        if(inElement == inRoot)
        {
            return list.reverse();
        }
        if(inElement.nodeType != 3)
        {
            list.push(inElement);
        }
    }
    return false;
}
function FindBefore(inElement1, inElement2)
{
    var list;
    list = [inElement1];
    if(inElement1 == inElement2)
    {
        return list;
    }
    while(inElement1 = inElement1.nextSibling)
    {
        if(inElement1.nodeType != 3)
        {
            list.push(inElement1);
        }
        if(inElement1 == inElement2)
        {
            return list;
        }
    }
    return false;
}
function FindBetween(inElement1, inElement2)
{
    var before;

    before = FindBefore(inElement1, inElement2);
    if(before)
    {
        return before;
    }

    before = FindBefore(inElement2, inElement1);
    if(before)
    {
        return before;
    }

    return false;
}
//// commands ////////////////////////////////
function ToHTML()
{
    SelectionRemove();
    var text = "";
    var str;
    var i;
    for(i=0; i<StageDOM.childNodes.length; i++)
    {
        text += (StageDOM.childNodes[i].outerHTML || StageDOM.childNodes[i].nodeValue);
    }

    PanelHTML.style.display = "block";
    PanelDOM.style.display = "none";

    StageHTML.value = text;
    StageHTML.scrollLeft = 0;
    StageHTML.scrollTop = 0;
    StageHTML.style.height = window.innerHeight - StageHTML.offsetTop - 50;
}
function ToDOM()
{
    SelectionRemove();
    StageDOM.innerHTML = StageHTML.value;
    PanelHTML.style.display = "none";
    PanelDOM.style.display = "block";
}
function QuoteBlockCreate()
{
    var block;
    var i;

    block = document.createElement("blockquote");
    if(!Selection.Across)
    {
        return false;
    }

    StageDOM.insertBefore(block, Selection.Across[0]);

    for(i=0; i<Selection.Across.length; i++)
    {
        block.appendChild(Selection.Across[i]);
    }
}
function QuoteBlockRemove()
{
    var block;
    var i;
    var text;

    if(!Selection.Across)
    {
        return false;
    }
        
    block = Selection.Across[0];
    
    while(block.firstChild)
    {
        StageDOM.insertBefore(block.firstChild, block);
    }
    StageDOM.removeChild(block);

}
function QuotePullCreate()
{
    var quote, string;
    quote = document.createElement("h6");
    string = Selection.Text;
    string = string.charAt(0).toUpperCase() + string.slice(1);
    if(string[string.length-1] != ".")
    {
        string = string.concat(".");
    }
    quote.innerHTML = string;
    StageDOM.insertBefore(quote, Selection.Across[0]);
    SelectionEmulateUser(quote);
}
function QuotePullRemove()
{
    if(!Selection.Across)
    {
        return;
    }
    if(Selection.Across[0].nodeName.toLowerCase() == "h6")
    {
        StageDOM.removeChild(Selection.Across[0]);
    }
}
function QuotePullMove(inDirection)
{
    var quote, reference;
    var selection;
    var range;

    if(!Selection.Across)
    {
        return;
    }

    quote = Selection.Across[0];
    if(quote.nodeName.toLowerCase() == "h6")
    {
        if(inDirection)
        {
            reference = quote.nextSibling.nextElementSibling
        }
        else
        {
            reference = quote.previousElementSibling;
        }
        StageDOM.insertBefore(quote, reference);

        SelectionEmulateUser(quote);
    }
}
function QuotePullSpread()
{
    var i;
    var quotes;
    var quote;
    var children;
    var child;
    var paddingStart;
    var paddingEnd;
    var spacing;
    var encountered, inserted;
    var elInsert, elReference;

    quotes = StageDOM.querySelectorAll("h6");
    available = [];
    for(i=0; i<quotes.length; i++)
    {
        quote = quotes[i];
        quote.parentNode.removeChild(quote);
    }

    paddingStart = 2;
    paddingEnd = 2;
    children = [];
    for(i=paddingStart; i<StageDOM.children.length; i++)
    {
        child = StageDOM.children[i];
        if(child.nodeName.toLowerCase() == "hr")
        {
            children.splice(children.length-paddingEnd, paddingEnd);
            //console.log("found the hr at", i);
            break;
        }
        children.push(child);
    }
    //console.log("total children:", StageDOM.children.length, "eligible children:", children.length);

    spacing = Math.ceil( (children.length-(paddingStart+paddingEnd)) / quotes.length );
    encountered = 0;
    inserted = 0;

    for(i=0; i<children.length; i++)
    {
        encountered++;
        if(encountered == spacing)
        {
            elInsert = quotes[inserted];
            elReference = children[i];
            StageDOM.insertBefore(elInsert, elReference);
            //console.log("inserted at", i);
            encountered = 0;
            inserted++;
        }
    }
}
function FootnoteRemove(andPull)
{
    var i;
    if(!Selection.Across)
    {
        return;
    }

    for(i=0; i<Selection.Across.length; i++)
    {
        var p = Selection.Across[i];
        var a = p.querySelector("a");
        if(!a)
        {
            continue;
        }
        var name = a.getAttribute("name");
        var otherA = document.querySelector("a[href='#"+name+"']");
        
        if(andPull)
        {
            var text = a.parentNode.innerHTML;

            quote = document.createElement("h6");
            quote.innerHTML = text.substring(text.indexOf("“")+1, text.indexOf("”"));
            StageDOM.insertBefore(quote, otherA.parentNode);
        }

        otherA.parentNode.removeChild(otherA);
        p.parentNode.removeChild(p);
    }
}
function FixTitles()
{
    function ProcessParagraph(inElement)
    {
        var prefix = "<strong>";
        var suffix = "</strong>";
        var replacement;
        if(inElement.innerHTML.substring(0, prefix.length) == prefix)
        {
            if(inElement.innerHTML.substring(inElement.innerHTML.length - suffix.length) == suffix)
            {
                replacement = document.createElement("h2");
                replacement.innerHTML = inElement.innerText;
                inElement.parentNode.replaceChild(replacement, inElement);
            }
        }
    }

    Iterate("p", ProcessParagraph);
}
function FixFootnotes()
{
    function ProcessCopy(inElement)
    {
        inElement.setAttribute("href", "#"+ (inElement.testContent || inElement.innerText));
    }
    function ProcessFooter(inElement)
    {
        inElement.setAttribute("name", inElement.testContent || inElement.innerText);
        inElement.removeAttribute("href");
    }

    Iterate("a[href*='#_ftnref']", ProcessFooter);
    Iterate("a[href*='#_ftn']", ProcessCopy)
    Iterate("a[href*='#_msoanchor']", ProcessFooter);
    Iterate("a[href*='#_msocom']", ProcessCopy);
}
function FixNewlines()
{
    StageHTML.value = StageHTML.value.replace(/^\s*$(?:\r\n?|\n)/gm, "");
}
function FixCustom()
{
    StageHTML.value = StageHTML.value.split(FARFind.value).join(FARReplace.value);
}
function FixSpaceStrands()
{
    StageHTML.value.indexOf("&nbsp;&nbsp;")
}
function SelectionCreate()
{
    SelectionRemove();

    var selection = DOMSelection();
    if(selection.Across)
    {
        Selection = selection;
        for(i=0; i<Selection.Across.length; i++)
        {
            Selection.Across[i].className = "Selection";
        }
        return true;
    }
    return false;
}
function SelectionRemove()
{
    if(Selection.Across)
    {
        for(i=0; i<Selection.Across.length; i++)
        {
            Selection.Across[i].removeAttribute("class");
        }
    }

}
function SelectionEmulateUser(inNode)
{
    var range, selection;
    range = document.createRange();
    range.selectNodeContents(inNode);
    selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    SelectionCreate();
}
        </script>
    </body>
</html>