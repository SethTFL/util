---
---
<!DOCTYPE html>
<html>
    <head>
        <script src="papaparse.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
        <style>
            input[data-import-csv]
            {
                padding:0.2rem;
                background:#ddd;
            }
            dt
            {
                font-weight:bold;
            }
            dt::after
            {
                content:":";
            }
            dd
            {
                margin-left:0;
            }
        </style>
    </head>
    <body>
        <p>
            <a target="_blank" href="https://www.truthforlife.org/admin/shop/order/export/">Get CSV from TFL Admin</a>
        </p>
        <div ng-app="App" ng-controller="Controller">
            <div class="input-group">
                <input type="file" data-import-csv class="form-control">
            </div>
            <dl ng-repeat="Code in Parsed.Codes track by $index">
                <dt>
                    <span ng-bind="Code.ID"></span> / <span ng-bind="Code.Name"></span>
                </dt>
                <dd><span ng-bind="Code.Count"></span></dd>
            </dl>
            <dl>
                <dt>
                    <span>Total</span>
                </dt>
                <dd><span ng-bind="Parsed.Total"></span></dd>
            </dl>
        </div>

        <script>
var App;
App = angular.module("App", []).config(["$interpolateProvider", function(inInterpolate){
    //inInterpolate.startSymbol('{[{').endSymbol('}]}');
}]);
App.directive("importCsv", ["$parse", "FactoryParser", function(inParser, FactoryParser){

    var directive = {};

    directive.link = function(inScope, inElement, inAttributes){

        function handlerEnter(inEvent){
            if(inEvent){
                inEvent.preventDefault();
            }
            inElement.addClass("Import");
            inEvent.dataTransfer.effectAllowed = 'copy';
            return false;
        }
        
        function handlerDrop(inEvent){
            inElement.removeClass("Import");
            if(inEvent){
                inEvent.preventDefault();
            }
            parse(event.dataTransfer.files[0]);
            return false;
        }
        
        function handlerChange(inEvent){
            inEvent.stopImmediatePropagation();
            parse(inEvent.target.files[0]);
        };
        
        function parse(inFile){
            FactoryParser.Parse(inFile, inScope.$apply);
        }
        
        function handlerLeave(){
            inElement.removeClass("Import");
        }
        
        
        
        inElement.on("dragenter dragstart dragend dragleave dragover drag drop", function (inEvent) {inEvent.preventDefault();});
        inElement.on('dragenter', handlerEnter);
        inElement.on('dragleave', handlerLeave);
        inElement.on('drop', handlerDrop);
        inElement.on('change', handlerChange);
        inElement.on('click', function(inEvent){
            inEvent.stopImmediatePropagation();
            
        })
    };
    
    return directive;
    
}]);
App.factory("FactoryParser", [function()
{
    var obj = {};
    obj.Fields = {
        Code:[],
        Quantity:[]
    };
    obj.Codes = [{
        ID:"30049",
        Name:"LeatherTouch",
        Count:0
    },
    {
        ID:"30050",
        Name:"Hardcover",
        Count:0
    },
    {
        ID:"30048",
        Name:"Black Leather (non-indexed)",
        Count:0
    },
    {
        ID:"30047",
        Name:"Black Leather (indexed)",
        Count:0
    }];
    obj.Total = 0;

    obj.Reset = function()
    {
        obj.Total = 0;
        for(i=0; i<obj.Codes.length; i++)
        {
            obj.Codes[i].Count = 0;
            obj.Codes[i].HasBeenSet = false;
        } 
    };
    obj.Parse = function(inData, inHandlerDone)
    {
        Papa.parse(inData, {
            complete: function(results) {
                var i, j, k;
                var row;
                var cell;
                var match;
                var count;
                var code;

                for(i=0; i<obj.Codes.length; i++)
                {
                    console.log("initial count:", obj.Codes[i]);
                }

                // go through the header and collect the code/qualtity column pairs
                for(i=0; i<results.data[0].length; i++)
                {
                    cell = results.data[0][i];
                    if(cell == "Product Code")
                    {
                        obj.Fields.Code.push(i);
                    }
                    if(cell == "Quantity")
                    {
                        obj.Fields.Quantity.push(i);
                    }
                }

                // reset the counts (doesnt work for some reason)
                obj.Reset();

                console.log("Rows:", results.data.length);
                for(i=1; i<results.data.length; i++)
                {
                    row = results.data[i];

                    //for each product code field in the row...
                    for(j=0; j<obj.Fields.Code.length; j++)
                    {
                        cell = row[obj.Fields.Code[j]];
                        // see if it has a code we are looking for..
                        for(k=0; k<obj.Codes.length; k++)
                        {
                            code = obj.Codes[k];
                            // if it has one of the codes we want...
                            if(code.ID == cell)
                            {
                                // tally up with the matchng quantity column
                                count = parseInt(row[obj.Fields.Quantity[j]]);
                                code.Count += count;
                                obj.Total += count;
                                code.HasBeenSet = true;
                                break;
                            }
                        }
                    }
                }
                inHandlerDone();

            }
        });

    };
    return obj;
}]);
App.controller("Controller", ["$scope", "FactoryParser", function($scope, FactoryParser)
{
    $scope.Parsed = FactoryParser;
}]);    
        </script>
    </body>
</html>
